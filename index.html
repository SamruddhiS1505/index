<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Crop Advisory</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Inter, sans-serif; background:#020617; color:#d1d5db; }
.card { background:#0f172a; padding:1rem; border-radius:.75rem; border:1px solid #1e293b; }
.btn { background:linear-gradient(to right,#0ea5e9,#2563eb); }
</style>
</head>

<body class="p-6 max-w-6xl mx-auto">

<h1 class="text-3xl text-white font-bold text-center mb-6">
Smart Crop Advisory
</h1>

<!-- NAV -->
<div class="flex justify-center gap-3 mb-6">
  <button onclick="switchTab('farmer')" class="px-4 py-2 bg-sky-600 rounded">Farmer</button>
  <button onclick="switchTab('logistics')" class="px-4 py-2 bg-slate-800 rounded">Logistics</button>
</div>

<!-- FARMER -->
<section id="farmer" class="card">
<h2 class="text-xl text-white font-semibold mb-4">Register Crop</h2>

<form id="registerForm" class="space-y-3">
  <input id="item_id" class="w-full p-3 bg-slate-800 rounded" placeholder="Crop ID" required>
  <input id="supplier" class="w-full p-3 bg-slate-800 rounded" placeholder="Farmer Name" required>
  <input id="serial_no" class="w-full p-3 bg-slate-800 rounded" placeholder="Serial No" required>
  <input id="crop_type" class="w-full p-3 bg-slate-800 rounded" placeholder="Crop Type">

  <div class="grid grid-cols-2 gap-2">
    <input id="sowing_date" type="date" class="p-3 bg-slate-800 rounded">
    <input id="harvest_date" type="date" class="p-3 bg-slate-800 rounded">
  </div>

  <div class="grid grid-cols-2 gap-2">
    <input id="manufactured_date" type="date" class="p-3 bg-slate-800 rounded">
    <input id="expiry_date" type="date" class="p-3 bg-slate-800 rounded">
  </div>

  <textarea id="advisory_notes" class="w-full p-3 bg-slate-800 rounded" placeholder="Advisory notes"></textarea>

  <button class="btn w-full p-3 text-white rounded font-semibold">
    Register Crop
  </button>
</form>

<h3 class="mt-6 text-white font-semibold">Registered Crops</h3>
<div id="cropList" class="mt-3 space-y-2"></div>
</section>

<!-- LOGISTICS -->
<section id="logistics" class="card hidden mt-6">
<h2 class="text-xl text-white font-semibold mb-4">Logistics Update</h2>

<form id="logisticsForm" class="space-y-3">
  <input id="log_item_id" class="w-full p-3 bg-slate-800 rounded" placeholder="Crop ID" required>
  <input id="log_customer" class="w-full p-3 bg-slate-800 rounded" placeholder="Current Holder">

  <select id="log_status" class="w-full p-3 bg-slate-800 rounded">
    <option>Shipped</option>
    <option>In Transit</option>
    <option>Delivered</option>
  </select>

  <button class="btn w-full p-3 text-white rounded font-semibold">
    Update Logistics
  </button>
</form>
</section>

<!-- QR MODAL -->
<div id="qrModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center">
<div class="bg-slate-800 p-6 rounded text-center max-w-sm w-full">
  <h3 class="text-white font-semibold mb-3">Crop QR Code</h3>
  <canvas id="qrCanvas" class="mx-auto bg-white p-2 rounded"></canvas>
  <p id="qrText" class="mt-2 text-slate-300 text-sm"></p>

  <div class="flex gap-2 mt-4">
    <button onclick="downloadQR()" class="bg-green-600 flex-1 text-white p-2 rounded">
      Download QR
    </button>
    <button onclick="closeQR()" class="bg-slate-600 flex-1 text-white p-2 rounded">
      Close
    </button>
  </div>
</div>
</div>

<script>
const supabase = window.supabase.createClient(
 "https://mklurhapkmthwmfhbtuc.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rbHVyaGFwa210aHdtZmhidHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2Nzg3NzEsImV4cCI6MjA4MDI1NDc3MX0.-I3I-oaOjKwp3lVQN_jYJYtxGyDUxpBR3TqF6bFsI4Y"
);

let allCrops = [];

function switchTab(t){
  farmer.classList.add("hidden");
  logistics.classList.add("hidden");
  document.getElementById(t).classList.remove("hidden");
}

async function loadCrops(){
  const {data} = await supabase.from("crops").select("*");
  allCrops = data || [];
  cropList.innerHTML = allCrops.map(c=>`
    <div class="bg-slate-800 p-3 rounded flex justify-between">
      <div>
        <div class="text-white">${c.crop_type}</div>
        <div class="text-xs text-slate-400">${c.item_id}</div>
      </div>
      <button onclick="openQR('${c.item_id}')" class="bg-slate-700 px-3 py-1 rounded">
        QR
      </button>
    </div>
  `).join("");
}
loadCrops();

registerForm.onsubmit = async e => {
 e.preventDefault();
 await supabase.from("crops").insert([{
   item_id:item_id.value,
   supplier:supplier.value,
   serial_no:serial_no.value,
   crop_type:crop_type.value,
   sowing_date:sowing_date.value,
   harvest_date:harvest_date.value,
   manufactured_date:manufactured_date.value,
   expiry_date:expiry_date.value,
   advisory_notes:advisory_notes.value,
   order_status:"Registered",
   timestamp:new Date()
 }]);
 registerForm.reset();
 loadCrops();
}

logisticsForm.onsubmit = async e => {
 e.preventDefault();
 await supabase.from("crops").insert([{
   item_id:log_item_id.value,
   customer:log_customer.value,
   order_status:log_status.value,
   timestamp:new Date()
 }]);
 alert("Logistics Updated");
}

function openQR(id){
 qrModal.classList.remove("hidden");
 qrText.textContent = id;
 new QRious({element:qrCanvas,value:id,size:220});
}

function closeQR(){
 qrModal.classList.add("hidden");
}

function downloadQR(){
 const link=document.createElement("a");
 link.href=qrCanvas.toDataURL("image/png");
 link.download=`CropQR_${qrText.textContent}.png`;
 link.click();
}
</script>

</body>
</html>
